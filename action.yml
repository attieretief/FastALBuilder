# action.yaml
name: 'Fast AL Builder'
description: 'Github Action to build AL Extensions quickly.'
author: 'Attie Retief'
branding:
  icon: 'package'
  color: 'blue'
inputs: 
  azure_connection_string:
    description: 'Azure Storage Account Connection String'
    required: true
  container_name:
    description: 'Azure Storage Account Container Name'
    required: true
  al_blob_name:
    description: 'AL Compiler Blob Name'
    required: true
  pfx_file:
    description: 'PFX File Name'
    required: true
  password:
    description: 'PFX Password'
    required: true
  
runs:
  using: 'composite'
  steps:
    - name: Checkout Repo to Compile
      uses: actions/checkout@v4
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
    - name: Install python dependencies
      uses: py-actions/py-dependency-install@v4
    - name: Install Code Signing Tool
      run: |
        sudo apt-get update
        sudo apt-get install -y osslsigncode
      shell: bash
    - name: Pass Inputs to Shell Environment Variables
      run: |
        echo "export AZ_CONNECTION_STRING='${{ inputs.azure_connection_string }}'" >> $GITHUB_ENV
        echo "export AZ_CONTAINER_NAME_TOOLS='${{ inputs.container_name }}'" >> $GITHUB_ENV
        echo "export AZ_ALC_FILENAME='${{ inputs.al_blob_name }}'" >> $GITHUB_ENV
        echo "export AZ_CERT_FILENAME='${{ inputs.pfx_file }}'" >> $GITHUB_ENV
        echo "export CERT_PASSWORD='${{ inputs.password }}'" >> $GITHUB_ENV
      shell: bash
    - name: Setup AL Compiler
      run: |
        python src/getAL.py
      shell: bash
    - name: Build AL Extension(s)
      run: |
        python src/build.py -r '${{ github.event.repository.name }}' -e  '${{ github.event_name }}' -c '${{ github.sha }}'
      shell: bash